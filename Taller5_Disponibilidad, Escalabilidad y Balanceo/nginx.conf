# nginx.conf

# Worker processes (1 es suficiente para el entorno de desarrollo)
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    ## 1. DEFINICIÓN DEL UPSTREAM (BACKENDS BALANCEABLES) ##
    # Este grupo contiene las direcciones internas de los servicios Central API.
    # El nombre 'ecomarket_central_backends' se usa en el proxy_pass.
    upstream ecomarket_central_backends {
        # Instancia 1: central1 usa el puerto 8000 interno.
        # max_fails y fail_timeout implementan el Health Check Pasivo.
        server central1:8000 max_fails=3 fail_timeout=30s; 
        
        # Instancia 2: central2 usa el puerto 8000 interno.
        server central2:8000 max_fails=3 fail_timeout=30s;
        
        # Ejemplo para el reto de escalabilidad:
        # server central3:8000 max_fails=3 fail_timeout=30s;
    }

    ## 2. CONFIGURACIÓN DEL SERVIDOR VIRTUAL (LOAD BALANCER) ##
    server {
        listen 80;
        server_name localhost;

        # Bloque principal para balancear TODO el tráfico entrante.
        location / {
            # CRÍTICO: Reenvía la petición al grupo de backends definido arriba (Round-Robin por defecto).
            proxy_pass http://ecomarket_central_backends; 
            
            # Asegura que las aplicaciones backend reciban información correcta sobre el cliente original
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
